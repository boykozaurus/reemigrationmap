<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Интерактивная карта маршрута</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet" />
    <link href="styles.css" rel="stylesheet" />
</head>
<body>
<div id="sidebar">
    <div id="routes-info"></div>
</div>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZmFsc2RmYXNkZiIsImEiOiJjbHp6emYyNTMxMWE2MnJyMmhoaWJ1M3g5In0.LHXcS21v9hGIpAW1YRWqbQ'; 

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [20.0, 50.0],
        zoom: 2,
        projection: 'mercator',
    });

    // Disable zoom on scroll
    map.scrollZoom.disable();

    let activeRouteIndex = null;
    let activeCard = null;
    let markers = [];

    // Function to close all cards
    function closeAllCards() {
        const allCards = document.querySelectorAll('.route-info-block');
        allCards.forEach(card => {
            card.classList.remove('is-opened');
        });
    }

    // Function to remove all markers from the map
    function removeMarkers() {
        markers.forEach(marker => marker.remove());
        markers = [];
    }

    // Load route data
    fetch('routeData.json')
        .then(response => response.json())
        .then(routeDataArray => {
            const routesInfoContainer = document.getElementById('routes-info');

            routeDataArray.forEach((geojsonData, index) => {
                const defaultColor = '#BDBDBD';
                const activeColor = '#790200';

                const routeInfoBlock = document.createElement('div');
                routeInfoBlock.classList.add('route-info-block');

                if (geojsonData.routeInfo.featuredImage) {
                    const routeImg = document.createElement('img');
                    routeImg.src = geojsonData.routeInfo.featuredImage;
                    routeImg.classList.add('route-info-img');
                    routeInfoBlock.appendChild(routeImg);

                    routeImg.addEventListener('click', () => {
                        handleCardToggle(routeInfoBlock, index);
                    });
                }

                const titleWrapper = document.createElement('div');
                titleWrapper.innerHTML = `
                    <div class="route-info-title-wrapper">
                        <h3 class="route-info-title">${geojsonData.routeInfo.title}</h3>
                    </div>
                `;

                const routeDescription = document.createElement('div');
                routeDescription.classList.add('route-info-description');
                routeDescription.innerHTML = `<p>${geojsonData.routeInfo.description}</p>`;

                routeInfoBlock.appendChild(titleWrapper);
                routeInfoBlock.appendChild(routeDescription);
                routesInfoContainer.appendChild(routeInfoBlock);

                titleWrapper.addEventListener('click', () => {
                    handleCardToggle(routeInfoBlock, index);
                });

                map.on('load', () => {
                    map.addSource(`route-${index}`, {
                        type: 'geojson',
                        data: geojsonData,
                    });

                    map.addLayer({
                        id: `route-${index}`,
                        type: 'line',
                        source: `route-${index}`,
                        filter: ['==', '$type', 'LineString'],
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round',
                        },
                        paint: {
                            'line-color': defaultColor,
                            'line-width': 4,
                            'line-opacity': 0.8,
                        },
                    });
                });

                // Automatically select the first card and route
                if (index === 0) {
                    handleCardToggle(routeInfoBlock, index);
                }

                function handleCardToggle(routeInfoBlock, index) {
                    if (activeCard && activeCard !== routeInfoBlock) {
                        activeCard.classList.remove('is-opened');
                        map.setPaintProperty(`route-${activeRouteIndex}`, 'line-color', defaultColor);
                        removeMarkers();
                    }

                    if (routeInfoBlock === activeCard) {
                        routeInfoBlock.classList.remove('is-opened');
                        map.setPaintProperty(`route-${index}`, 'line-color', defaultColor);
                        removeMarkers();
                        activeCard = null;
                        activeRouteIndex = null;
                    } else {
                        routeInfoBlock.classList.add('is-opened');
                        map.setPaintProperty(`route-${index}`, 'line-color', activeColor);
                        addMarkers(geojsonData.features);
                        map.fitBounds(getRouteBounds(geojsonData), {
                            padding: 50,
                            maxZoom: 10,
                        });
                        activeCard = routeInfoBlock;
                        activeRouteIndex = index;
                    }
                }

                function addMarkers(features) {
                    features.forEach(function (feature) {
                        if (feature.geometry.type === 'Point') {
                            const popup = new mapboxgl.Popup({ offset: 25 }).setText(
                                `${feature.properties.city}: ${feature.properties.event}`
                            );

                            const el = document.createElement('div');
                            el.style.width = '25px';
                            el.style.height = '25px';
                            el.style.backgroundColor = '#4e1512';
                            el.style.borderRadius = '50%';
                            el.style.boxShadow = '0 0 5px rgba(78, 21, 18, 0.5)';

                            const marker = new mapboxgl.Marker({ element: el })
                                .setLngLat(feature.geometry.coordinates)
                                .setPopup(popup)
                                .addTo(map);

                            markers.push(marker);
                        }
                    });
                }

                function getRouteBounds(geojsonData) {
                    const bounds = new mapboxgl.LngLatBounds();
                    geojsonData.features.forEach((feature) => {
                        if (feature.geometry.coordinates) {
                            bounds.extend(feature.geometry.coordinates);
                        }
                    });
                    return bounds;
                }
            });
        });
</script>
</body>
</html>
